---
import BaseLayout from '../../layouts/BaseLayout.astro';

// ORCIDs
const ORCIDS = [
  { id: '0000-0003-3659-6769', name: 'Dr. Humberto Carrillo Calvet' },
  { id: '0000-0003-3453-7159', name: 'Dr. José Luis Jiménez Andrade' }
];

// Fetch works
interface OrcidWork {
  title: string;
  journal: string | null;
  pubDate: Date;
  url: string | null;
  doi: string | null;
  type: string;
  source: string;
}

// Helper to fetch (duplicated logic for simplicity within Astro component context)
// Utilizing public API endpoint for works summary
async function fetchOrcidWorks(orcidId: string, authorName: string): Promise<OrcidWork[]> {
  try {
    const response = await fetch(`https://pub.orcid.org/v3.0/${orcidId}/works`, {
      headers: { 'Accept': 'application/json' }
    });
    
    if (!response.ok) return [];
    
    const data = await response.json();
    return data.group.map((group: any) => {
      const summary = group['work-summary'][0];
      
      // Extract date
      let date = new Date();
      if (summary['publication-date']) {
        const year = summary['publication-date'].year?.value;
        const month = summary['publication-date'].month?.value || '01';
        const day = summary['publication-date'].day?.value || '01';
        if (year) {
            date = new Date(`${year}-${month}-${day}`);
        }
      }

      // Extract DOI
      let doi = null;
      if (summary['external-ids']?.['external-id']) {
        const doiObj = summary['external-ids']['external-id'].find((id: any) => id['external-id-type'] === 'doi');
        if (doiObj) doi = doiObj['external-id-value'];
      }

      return {
        title: summary.title.title.value,
        journal: summary['journal-title']?.value || null,
        pubDate: date,
        url: summary.url?.value || (doi ? `https://doi.org/${doi}` : null),
        doi: doi,
        type: summary.type,
        source: authorName
      };
    }).filter((w: OrcidWork) => w.title); // Filter empty titles
  } catch (e) {
    console.error(e);
    return [];
  }
}

// Fetch all works in parallel
const allWorksPromises = ORCIDS.map(orcid => fetchOrcidWorks(orcid.id, orcid.name));
const results = await Promise.all(allWorksPromises);

// Combine and deduplicate
const allWorks = results.flat();
const uniqueWorks = Array.from(new Map(allWorks.map(item => [item.title.toLowerCase().trim(), item])).values());

// Sort by date descending
uniqueWorks.sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());

// Group by year
const worksByYear = uniqueWorks.reduce((acc, work) => {
  const year = work.pubDate.getFullYear().toString();
  if (!acc[year]) acc[year] = [];
  acc[year].push(work);
  return acc;
}, {} as Record<string, OrcidWork[]>);

const sortedYears = Object.keys(worksByYear).sort((a, b) => parseInt(b) - parseInt(a));
---

<BaseLayout title="Publicaciones" description="Publicaciones científicas del Laboratorio de Dinámica No Lineal">
  <main class="min-h-screen bg-white dark:bg-gray-900">
    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-unam-blue-600 to-accent-purple-600 text-white py-20">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center">
          <h1 class="text-4xl md:text-5xl font-display font-bold mb-6 animate-fade-in">
            Publicaciones Científicas
          </h1>
          <p class="text-xl text-white/90 animate-fade-in" style="animation-delay: 0.2s">
            Producción científica reciente de los investigadores del laboratorio, obtenida directamente de ORCID.
          </p>
          <div class="flex justify-center gap-4 mt-8 animate-fade-in" style="animation-delay: 0.4s">
            {ORCIDS.map(orcid => (
              <a 
                href={`https://orcid.org/${orcid.id}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-4 py-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors text-sm"
              >
                <img src="https://orcid.org/sites/default/files/images/orcid_16x16.png" class="w-4 h-4 mr-2" alt="ORCID" />
                {orcid.name}
              </a>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- Publications List -->
    <section class="py-16">
      <div class="container mx-auto px-4 max-w-5xl">
        {sortedYears.map(year => (
          <div class="mb-12 animate-fade-in">
            <h2 class="text-3xl font-display font-bold text-gray-900 dark:text-white mb-6 border-b border-gray-200 dark:border-gray-700 pb-2">
              {year}
            </h2>
            <div class="space-y-6">
              {worksByYear[year].map(work => (
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                  <div class="flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                            {work.url ? (
                                <a href={work.url} target="_blank" rel="noopener noreferrer" class="hover:text-unam-blue-500 dark:hover:text-accent-cyan-500 transition-colors">
                                    {work.title}
                                </a>
                            ) : (
                                work.title
                            )}
                        </h3>
                        {work.journal && (
                            <p class="text-gray-700 dark:text-gray-300 font-medium mb-1">
                                {work.journal}
                            </p>
                        )}
                        <div class="flex flex-wrap gap-2 mt-3 text-sm text-gray-500 dark:text-gray-400">
                             {work.doi && (
                                <span class="bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded">
                                    DOI: {work.doi}
                                </span>
                             )}
                             <span class="capitalize bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded">
                                {work.type.replace('-', ' ')}
                             </span>
                        </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>
  </main>
</BaseLayout>
